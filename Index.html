<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banana Empire: Pixel Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --pixel-border: 6px solid #000;
            --accent: #facc15;
            --main-bg: #064e3b;
            --panel-bg: #78350f;
            --header-bg: #166534;
            --text-box: #fef9c3;
        }

        .pixel-engine { image-rendering: pixelated; filter: url(#pixelate) contrast(150%) saturate(130%); }

        /* THEMES */
        body.theme-default { --main-bg: #064e3b; --accent: #facc15; }
        body.theme-newyear { --main-bg: #1e1b4b; --panel-bg: #312e81; --header-bg: #4338ca; --accent: #fcd34d; }
        body.theme-valentine { --main-bg: #4c0519; --panel-bg: #831843; --header-bg: #9d174d; --accent: #fda4af; }
        body.theme-stpatricks { --main-bg: #052e16; --panel-bg: #14532d; --header-bg: #166534; --accent: #4ade80; }
        body.theme-july4 { --main-bg: #082f49; --panel-bg: #1e3a8a; --header-bg: #b91c1c; --accent: #93c5fd; }
        body.theme-halloween { --main-bg: #0c0a09; --panel-bg: #441907; --header-bg: #ea580c; --accent: #fb923c; }
        body.theme-thanksgiving { --main-bg: #451a03; --panel-bg: #78350f; --header-bg: #b45309; --accent: #fcd34d; }
        body.theme-christmas { --main-bg: #052e16; --panel-bg: #7f1d1d; --header-bg: #991b1b; --accent: #fecaca; }

        body, html { height: 100%; margin: 0; font-family: 'VT323', monospace; background-color: var(--main-bg); overflow: hidden; display: flex; flex-direction: column; transition: all 0.5s ease; }
        
        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: var(--text-box); border: var(--pixel-border); width: 85%; max-width: 650px; padding: 25px; box-shadow: 10px 10px 0 #000; max-height: 85vh; overflow-y: auto; }
        .modal-header { font-size: 3rem; color: #000; border-bottom: 6px solid #000; margin-bottom: 20px; text-align: center; text-transform: uppercase; }
        .modal-text { font-size: 1.4rem; color: #000; line-height: 1.3; }
        .close-btn { background: #ef4444; color: white; border: var(--pixel-border); padding: 12px 25px; font-family: 'VT323'; font-size: 1.8rem; cursor: pointer; display: block; margin: 20px auto 0; box-shadow: 4px 4px 0 #000; }
        .help-trigger { background: #000; color: #facc15; padding: 10px; text-align: center; cursor: pointer; border-bottom: var(--pixel-border); font-size: 1.4rem; }

        /* GAME LAYOUT */
        .main-game-area { position: relative; z-index: 1; display: grid; grid-template-columns: 320px 1fr 320px; flex: 1; padding: 10px; gap: 15px; height: calc(100vh - 40px); }
        .side-panel { border: var(--pixel-border); background: var(--panel-bg); display: flex; flex-direction: column; box-shadow: 8px 8px 0 #000; overflow-y: auto; }
        .center-stage { display: flex; flex-direction: column; align-items: center; padding: 10px; gap: 10px; }
        .header { background: var(--header-bg); color: var(--accent); padding: 12px; font-size: 1.8rem; text-align: center; border-bottom: var(--pixel-border); text-transform: uppercase; position: sticky; top: 0; z-index: 10;}

        /* CLICKER & PARTICLES */
        #particle-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .particle { position: absolute; font-size: 24px; animation: fall linear forwards; }
        @keyframes fall { to { transform: translateY(110vh) rotate(360deg); } }

        #golden-item { position: fixed; font-size: 80px; cursor: pointer; z-index: 100; display: none; filter: drop-shadow(0 0 30px gold) brightness(1.4); animation: g-float 2s infinite ease-in-out; }
        @keyframes g-float { 0%, 100% { transform: scale(1) rotate(-10deg); } 50% { transform: scale(1.2) rotate(10deg); } }

        .stats-box { background: var(--text-box); border: var(--pixel-border); padding: 15px; width: 100%; text-align: center; box-shadow: 6px 6px 0 #000; }
        #emoji-clicker { font-size: 140px; cursor: pointer; user-select: none; transition: transform 0.05s; margin: 15px 0; }
        #emoji-clicker:active { transform: scale(0.85); }

        .news-ticker { height: 45px; background: #000; border-top: var(--pixel-border); color: var(--accent); display: flex; align-items: center; overflow: hidden; position: relative; z-index: 10; }
        .ticker-text { display: inline-block; padding-left: 100%; animation: scroll-news 50s linear infinite; font-size: 1.6rem; white-space: nowrap; }
        @keyframes scroll-news { from { transform: translateX(0); } to { transform: translateX(-800%); } }

        .buy-card { background: var(--header-bg); border: 4px solid #000; color: var(--accent); padding: 10px; margin: 8px; cursor: pointer; text-align: left; display: none; box-shadow: 4px 4px 0 #000; }
        .buy-card.visible { display: block; }
        .buy-card.disabled { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; }
        .buy-card span { float: right; font-weight: bold; }
        .inv-row { border-bottom: 2px solid #000; padding: 8px 12px; background: rgba(0,0,0,0.3); color: white; font-size: 1.2rem; }
        
        .leaderboard-box { width: 100%; background: #000; border: var(--pixel-border); color: var(--accent); padding: 10px; box-shadow: 6px 6px 0 #000; flex: 1; overflow-y: auto; }
        .lb-row { display: flex; justify-content: space-between; padding: 6px; border-bottom: 1px solid #333; font-size: 1.3rem; }
        .me { background: #222; border-left: 6px solid var(--accent); }
        #save-notify { position: fixed; bottom: 60px; right: 20px; color: #4ade80; background: #000; padding: 5px 10px; border: 2px solid #4ade80; display: none; z-index: 1000; }
    </style>
</head>
<body id="game-body" class="theme-default">

<div id="welcome-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">Empire Initialized</div>
        <div class="modal-text">
            <p><strong>üçå CLICK:</strong> Use the central fruit to generate your starting capital.</p>
            <p><strong>üè¢ INFRASTRUCTURE:</strong> Market (Left) for Click Power, Producers (Right) for Automation.</p>
            <p><strong>üóûÔ∏è GNN NEWS:</strong> Real history and absurd banana fiction based on your season.</p>
            <p><strong>üíæ AUTOSAVE:</strong> Your progress is automatically saved every 5 seconds!</p>
        </div>
        <button class="close-btn" onclick="closeWelcome()">BEGIN OPERATION</button>
    </div>
</div>

<div id="help-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">Manual V.2</div>
        <div class="modal-text" id="help-content"></div>
        <button class="close-btn" onclick="toggleHelp()">RESUME PRODUCTION</button>
    </div>
</div>

<div id="particle-container"></div>
<div id="golden-item" class="pixel-engine" onclick="triggerFrenzy()">üçå</div>
<div id="save-notify">SAVED TO CLOUD</div>

<svg width="0" height="0" style="position:absolute"><filter id="pixelate" x="0" y="0"><feFlood x="4" y="4" height="2" width="2"/><feComposite width="4" height="4"/><feTile/><feComposite in="SourceGraphic" operator="in"/><feMorphology operator="dilate" radius="1.5"/></filter></svg>

<div class="main-game-area">
    <div class="side-panel">
        <div class="help-trigger" onclick="toggleHelp()">[ DOCUMENTATION ]</div>
        <div class="header">Market</div>
        <div id="market-list"></div>
        <div class="header" style="margin-top:20px;">Timeline</div>
        <div style="padding:15px;">
            <select id="theme-sel" onchange="setTheme(this.value)" style="width:100%; font-family:'VT323'; background:#000; color:white; border:4px solid var(--accent); font-size:1.4rem;">
                <option value="default">JUNGLE üå¥</option>
                <option value="newyear">NEW YEAR üéÜ</option>
                <option value="valentine">VALENTINE ‚ù§Ô∏è</option>
                <option value="stpatricks">ST. PATRICK üçÄ</option>
                <option value="july4">INDEPENDENCE üá∫üá∏</option>
                <option value="halloween">SPOOKY üéÉ</option>
                <option value="thanksgiving">HARVEST ü¶É</option>
                <option value="christmas">WINTER üéÑ</option>
            </select>
        </div>
    </div>

    <div class="center-stage">
        <div id="frenzy-timer" style="display:none; color:gold; font-size:1.8rem; font-weight:bold; text-shadow:2px 2px #000;">FRENZY ACTIVE: <span id="ftime">30</span>s</div>
        <div style="background:#000; border:4px solid var(--accent); padding:8px 20px; cursor:pointer; width:100%; text-align:center;" onclick="renameEmpire()">
            <div id="name-tag" style="color:white; font-size: 1.6rem;">[ RENAME EMPIRE ]</div>
        </div>
        <div class="stats-box">
            <div id="score" style="font-size: 4rem; color: #000; line-height:1;">0</div>
            <div style="display:flex; justify-content: space-around; font-size: 1.5rem; color: #000; border-top: 3px solid #000; margin-top:10px; padding-top:5px;">
                <div>BPS: <span id="bps">0</span></div>
                <div>POWER: <span id="pow">1</span></div>
            </div>
        </div>
        <div id="emoji-clicker" class="pixel-engine">üçå</div>
        <div class="leaderboard-box"><div id="lb-content">Synchronizing...</div></div>
    </div>

    <div class="side-panel">
        <div class="header">Producers</div>
        <div id="producer-list"></div>
        <div class="header" style="margin-top:10px;">Assets</div>
        <div id="inv-list"></div>
    </div>
</div>

<div class="news-ticker"><div class="ticker-text" id="news-content">GNN: CONNECTING...</div></div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyCTmXjtfuN-2DGJq9IUpCVvDk88IkFQSFg", authDomain: "banana-empire-42fda.firebaseapp.com", databaseURL: "https://banana-empire-42fda-default-rtdb.firebaseio.com", projectId: "banana-empire-42fda", storageBucket: "banana-empire-42fda.firebasestorage.app", messagingSenderId: "833181965750", appId: "1:833181965750:web:2abf119335bee9a0157517" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let bananas = 0, bps = 0, clickPower = 1, currentTheme = 'default';
    let myName = localStorage.getItem('bananaName') || "CEO_" + Math.floor(Math.random() * 999);
    let isFrenzy = false, frenzyMult = 1;

    // OVERFLOWING NEWS DATABASE
    const newsDatabase = {
        default: ["[REAL] Bananas are berries.", "[FAKE] Giant banana moon discovered.", "[REAL] 100B eaten yearly.", "[FAKE] Peels used as road fuel."],
        newyear: ["[REAL] Ball drop since 1907.", "[FAKE] 2026 canceled due to potassium shortage.", "[REAL] First resolutions 4,000 years ago."],
        valentine: ["[REAL] 145M cards sent today.", "[FAKE] Cupid now shoots banana slices.", "[REAL] First heart-shaped chocolates in 1861."],
        stpatricks: ["[REAL] Blue was the original color.", "[FAKE] Leprechaun caught hoarding bananas.", "[REAL] Chicago dyes river green since 1962."],
        july4: ["[REAL] 150M hot dogs eaten today.", "[FAKE] Eagle carrying giant fruit over DC.", "[REAL] 3 Presidents died on July 4."],
        halloween: ["[REAL] Jack-o'-lanterns were originally turnips.", "[FAKE] Ghost slips on own ectoplasm.", "[REAL] Halloween is $10B industry."],
        thanksgiving: ["[REAL] First lasted 3 days.", "[FAKE] Turkey wears banana suit.", "[REAL] Sarah Hale saved the holiday."],
        christmas: ["[REAL] Jingle Bells space song.", "[FAKE] Santa swaps reindeer for monkeys.", "[REAL] Tallest tree was 221ft."]
    };

    const upgrades = {
        market: [ {id:'m1', name:'Plastic Peeler', cost:15, power:1}, {id:'m2', name:'Metal Knife', cost:100, power:5}, {id:'m3', name:'Slicer', cost:500, power:15}, {id:'m4', name:'Nano-Blade', cost:2000, power:50}, {id:'m5', name:'Laser', cost:10000, power:200} ],
        producer: [ {id:'p1', name:'Monkey', cost:50, bps:2, icon:'üêí'}, {id:'p2', name:'Tree', cost:250, bps:10, icon:'üå≥'}, {id:'p3', name:'Truck', cost:1000, bps:45, icon:'üöö'}, {id:'p4', name:'Farm', cost:5000, bps:150, icon:'üöú'}, {id:'p5', name:'Factory', cost:20000, bps:500, icon:'üè≠'} ]
    };
    let counts = {}; [...upgrades.market, ...upgrades.producer].forEach(u => counts[u.id] = 0);

    const seasonalIcons = { default:'üçå', halloween:'üéÉ', christmas:'üéÑ', newyear:'üéÜ', valentine:'‚ù§Ô∏è', stpatricks:'üçÄ', july4:'üá∫üá∏', thanksgiving:'ü¶É' };

    // SAVE & LOAD LOGIC
    function saveGame() {
        const gameState = { bananas, bps, clickPower, counts, myName, currentTheme };
        localStorage.setItem('bananaEmpire_SavedData', JSON.stringify(gameState));
        db.ref('players/' + myName).set({ name: myName, score: Math.floor(bananas) });
        
        // Notify
        const sn = document.getElementById('save-notify');
        sn.style.display = 'block';
        setTimeout(() => sn.style.display = 'none', 1000);
    }

    function loadGame() {
        const saved = localStorage.getItem('bananaEmpire_SavedData');
        if (saved) {
            const data = JSON.parse(saved);
            bananas = data.bananas || 0;
            bps = data.bps || 0;
            clickPower = data.clickPower || 1;
            counts = data.counts || counts;
            myName = data.myName || myName;
            currentTheme = data.currentTheme || 'default';
            document.getElementById('theme-sel').value = currentTheme;
            setTheme(currentTheme);
        }
    }

    // UI & HELP
    if (!localStorage.getItem('returningPlayer')) { document.getElementById('welcome-modal').style.display = 'flex'; }
    function closeWelcome() { document.getElementById('welcome-modal').style.display = 'none'; localStorage.setItem('returningPlayer', 'true'); }
    function toggleHelp() {
        const modal = document.getElementById('help-modal');
        document.getElementById('help-content').innerHTML = `
            <p><strong>GOLDEN FRENZY:</strong> Every 50s, a Golden Banana spawns. Click for 30s of 2X Power!</p>
            <p><strong>FOG OF WAR:</strong> Items hide until you have 70% of the cost.</p>
            <p><strong>AUTO-SAVE:</strong> Progress is saved to your browser and global leaderboards every 5 seconds.</p>
        `;
        modal.style.display = (modal.style.display === 'none') ? 'flex' : 'none';
    }

    function setTheme(v) {
        currentTheme = v; document.body.className = 'theme-' + v;
        const pool = newsDatabase[currentTheme];
        document.getElementById('news-content').innerText = pool[Math.floor(Math.random()*pool.length)];
        document.getElementById('emoji-clicker').innerText = seasonalIcons[v];
    }

    // ENGINE
    function triggerFrenzy() {
        if(isFrenzy) return; isFrenzy = true; frenzyMult = 2;
        document.getElementById('golden-item').style.display='none'; document.getElementById('frenzy-timer').style.display='block';
        let t = 30; const clock = setInterval(() => {
            t--; document.getElementById('ftime').innerText = t;
            if(t<=0) { clearInterval(clock); isFrenzy=false; frenzyMult=1; document.getElementById('frenzy-timer').style.display='none'; }
        }, 1000);
    }

    function buyMarket(id) {
        const u = upgrades.market.find(x => x.id === id);
        if(bananas >= u.cost) { bananas -= u.cost; clickPower += u.power; counts[id]++; updateUI(); }
    }
    function buyProducer(id) {
        const u = upgrades.producer.find(x => x.id === id);
        if(bananas >= u.cost) { bananas -= u.cost; bps += u.bps; counts[id]++; updateUI(); }
    }

    function updateUI() {
        document.getElementById('score').innerText = Math.floor(bananas).toLocaleString();
        document.getElementById('bps').innerText = (bps * frenzyMult).toLocaleString();
        document.getElementById('pow').innerText = (clickPower * frenzyMult).toLocaleString();
        document.getElementById('name-tag').innerText = myName;
        [...upgrades.market, ...upgrades.producer].forEach(u => {
            const btn = document.getElementById('btn-' + u.id);
            if(bananas >= u.cost * 0.7 || counts[u.id] > 0) btn.classList.add('visible');
            btn.classList.toggle('disabled', bananas < u.cost);
        });
        let inv = ""; upgrades.producer.forEach(u => { if(counts[u.id]>0) inv += `<div class="inv-row">${u.icon} ${u.name}: ${counts[u.id]}</div>`; });
        document.getElementById('inv-list').innerHTML = inv || "No assets...";
    }

    function renameEmpire() {
        const n = prompt("Change Empire ID?");
        if(n) { db.ref('players/' + myName).remove(); myName = n.substring(0, 12).toUpperCase(); localStorage.setItem('bananaName', myName); updateUI(); }
    }

    // INIT
    upgrades.market.forEach(u => document.getElementById('market-list').innerHTML += `<div class="buy-card" id="btn-${u.id}" onclick="buyMarket('${u.id}')">${u.name} <span>$${u.cost}</span></div>`);
    upgrades.producer.forEach(u => document.getElementById('producer-list').innerHTML += `<div class="buy-card" id="btn-${u.id}" onclick="buyProducer('${u.id}')">${u.name} <span>$${u.cost}</span></div>`);
    
    loadGame();
    updateUI();

    document.getElementById('emoji-clicker').onclick = () => { bananas += (clickPower * frenzyMult); updateUI(); };
    setInterval(() => { const p=document.createElement('div'); p.className='particle'; p.innerText=seasonalIcons[currentTheme]; p.style.left=Math.random()*100+'vw'; p.style.animationDuration=(Math.random()*3+3)+'s'; document.getElementById('particle-container').appendChild(p); setTimeout(()=>p.remove(), 6000); }, 400);
    setInterval(() => { const g=document.getElementById('golden-item'); g.style.left=Math.random()*70+15+'vw'; g.style.top=Math.random()*70+15+'vh'; g.style.display='block'; setTimeout(()=>g.style.display='none', 7000); }, 50000);
    setInterval(() => { bananas += (bps * frenzyMult)/10; updateUI(); }, 100);
    setInterval(saveGame, 5000);

    db.ref('players').orderByChild('score').limitToLast(10).on('value', (snap) => {
        const val = snap.val(); let p = []; for(let k in val) p.push(val[k]);
        p.sort((a,b) => b.score - a.score);
        document.getElementById('lb-content').innerHTML = p.map((x, i) => `<div class="lb-row ${x.name === myName ? 'me' : ''}"><span>#${i+1} ${x.name}</span><span>${x.score.toLocaleString()}</span></div>`).join('');
    });
</script>
</body>
</html>
