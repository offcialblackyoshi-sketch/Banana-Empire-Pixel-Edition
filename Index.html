<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banana Empire: Pixel Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --pixel-border: 6px solid #000;
            --accent: #facc15;
            --main-bg: #064e3b;
            --panel-bg: #78350f;
            --header-bg: #166534;
            --text-box: #fef9c3;
        }

        /* THEMES */
        body.theme-default { --main-bg: #064e3b; --accent: #facc15; --header-bg: #166534; --panel-bg: #78350f; --text-box: #fef9c3; }
        body.theme-newyear { --main-bg: #1e1b4b; --accent: #fcd34d; --header-bg: #312e81; --panel-bg: #1e1b4b; --text-box: #eef2ff; }
        body.theme-valentine { --main-bg: #4c0519; --accent: #fda4af; --header-bg: #9d174d; --panel-bg: #831843; --text-box: #ffe4e6; }
        body.theme-july4 { --main-bg: #0a1128; --accent: #ef4444; --header-bg: #1e3a8a; --panel-bg: #0a1128; --text-box: #f1f5f9; }
        body.theme-halloween { --main-bg: #0c0a09; --accent: #fb923c; --header-bg: #ea580c; --panel-bg: #441907; --text-box: #fed7aa; }
        body.theme-christmas { --main-bg: #052e16; --accent: #ef4444; --header-bg: #991b1b; --panel-bg: #7f1d1d; --text-box: #fee2e2; }

        body, html { height: 100%; margin: 0; font-family: 'VT323', monospace; background-color: var(--main-bg); overflow: hidden; display: flex; flex-direction: column; transition: all 0.5s ease; }
        
        .pixel-engine { 
            image-rendering: pixelated; 
            image-rendering: -moz-crisp-edges; 
            image-rendering: crisp-edges;
            filter: url(#pixelate) contrast(150%) saturate(120%); 
            display: inline-block; 
        }
        
        .main-game-area { display: grid; grid-template-columns: 320px 1fr 320px; flex: 1; padding: 15px; gap: 20px; height: calc(100vh - 65px); z-index: 10; position: relative; }
        .side-panel { border: var(--pixel-border); background: var(--panel-bg); display: flex; flex-direction: column; overflow-y: auto; box-shadow: 8px 8px 0 #000; }
        .center-stage { display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 10px 0; height: 100%; }
        
        .header { background: var(--header-bg); color: var(--accent); padding: 12px; font-size: 1.8rem; text-align: center; border-bottom: var(--pixel-border); text-transform: uppercase; }
        .buy-card { background: var(--header-bg); border: 4px solid #000; color: var(--accent); padding: 10px; margin: 8px; cursor: pointer; display: none; position: relative; box-shadow: 0 4px 0 #000; transition: transform 0.05s; }
        .buy-card.discovered { display: block; }
        .buy-card:active { transform: translateY(2px); box-shadow: 0 2px 0 #000; }
        .buy-card.locked { filter: brightness(0.4); cursor: not-allowed; }
        
        .owned-tag { position: absolute; top: -10px; right: -5px; background: #000; color: #fff; padding: 1px 6px; font-size: 0.9rem; border: 2px solid var(--accent); z-index: 5; }
        
        .name-box { background: #000; border: var(--pixel-border); padding: 5px 15px; margin-bottom: 10px; color: var(--accent); width: 95%; box-sizing: border-box; box-shadow: 6px 6px 0 rgba(0,0,0,0.3); display: flex; justify-content: space-between; align-items: center; }
        .stats-box { background: var(--text-box); border: var(--pixel-border); padding: 12px; width: 95%; text-align: center; box-shadow: 10px 10px 0 #000; }
        .score-display { font-size: 3.5rem; color: #000; line-height: 0.9; }

        .leaderboard-container { width: 100%; background: #000; border: var(--pixel-border); color: var(--accent); flex: 1; overflow: hidden; margin-top: 15px; box-shadow: 8px 8px 0 rgba(0,0,0,0.5); display: flex; flex-direction: column; }
        #lb-content { overflow-y: auto; flex: 1; font-size: 1.4rem; padding: 5px; }
        .lb-entry { display: flex; justify-content: space-between; padding: 4px 8px; border-bottom: 1px solid #333; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .modal-content { background: var(--panel-bg); border: 10px solid #000; padding: 30px; color: white; width: 80%; max-width: 500px; text-align: center; box-shadow: 15px 15px 0 var(--accent); }
        .btn-close { background: var(--accent); color: #000; border: 4px solid #000; padding: 10px 20px; font-family: 'VT323'; font-size: 1.5rem; cursor: pointer; margin-top: 20px; }
        .help-btn { cursor: pointer; color: #fff; background: #444; padding: 2px 8px; border: 2px solid #fff; font-size: 1rem; }

        #chat-container { margin-top: 15px; border: 4px solid #000; height: 140px; display: flex; flex-direction: column; background: #000; }
        #chat-msgs { flex: 1; overflow-y: auto; color: white; padding: 6px; font-size: 1rem; line-height: 1.1; word-wrap: break-word; }
        #chat-in { background: #222; border: none; border-top: 2px solid #444; color: var(--accent); font-family: 'VT323'; padding: 8px; font-size: 1.1rem; outline: none; }
        .chat-name { color: var(--accent); font-weight: bold; }

        #rebirth-zone { display: none; margin-top: 10px; text-align: center; width: 90%; }
        .rebirth-btn { background: #ef4444; border: 4px solid #000; color: white; padding: 8px; font-size: 1.4rem; cursor: pointer; box-shadow: 0 4px 0 #000; }

        #emoji-clicker { font-size: 160px; cursor: pointer; user-select: none; transition: transform 0.05s; margin: 5px 0; }
        #emoji-clicker:active { transform: scale(0.85); }

        .asset-row { display: flex; align-items: center; gap: 10px; padding: 8px; border-bottom: 1px solid rgba(0,0,0,0.4); background: rgba(0,0,0,0.2); color: white; font-size: 0.9rem; }
        .asset-icon { font-size: 2.5rem; width: 45px; text-align: center; line-height: 1; display: inline-block; } 

        .special-spawn { position: absolute; font-size: 50px; cursor: pointer; z-index: 100; animation: floatSpecial 10s linear forwards; user-select: none; }
        .golden-b { filter: drop-shadow(0 0 10px gold) url(#pixelate); }
        .angelic-b { filter: drop-shadow(0 0 15px #00ffff) url(#pixelate); }
        @keyframes floatSpecial {
            from { left: -100px; top: var(--start-y); }
            to { left: 110vw; top: var(--end-y); }
        }

        #particle-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
        .falling-item { position: absolute; font-size: 35px; animation: fall linear forwards; pointer-events: auto; }
        @keyframes fall { from { top: -10vh; transform: rotate(0deg); } to { top: 110vh; transform: rotate(360deg); } }
        
        .omega-glow { animation: glow 2s infinite alternate; }
        @keyframes glow { from { box-shadow: 0 0 5px #fff; } to { box-shadow: 0 0 20px var(--accent); } }
    </style>
</head>
<body class="theme-default">

<svg width="0" height="0" style="position:absolute">
    <filter id="pixelate" x="0" y="0">
        <feFlood x="4" y="4" height="2" width="2"/>
        <feComposite width="4" height="4"/>
        <feTile/>
        <feComposite in="SourceGraphic" operator="in"/>
        <feMorphology operator="dilate" radius="1"/>
    </filter>
</svg>

<div id="modal-overlay" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h1 id="modal-title" style="color:var(--accent); text-transform:uppercase;">Welcome to Banana Empire!</h1>
        <div id="modal-body" style="font-size:1.3rem; text-align:left;">
            * <b>CLICK</b> the banana to earn points.<br>
            * <b>MARKET:</b> Upgrades your click power.<br>
            * <b>WORKFORCE:</b> Generates bananas automatically (BPS).<br>
            * <b>SPECIALS:</b> Watch for Golden (15% chance) and Angelic (1% chance) bananas!<br>
            * <b>REBIRTH:</b> Reset at 1B to get 2x permanent boost.
        </div>
        <button class="btn-close" onclick="closeModal()">GOT IT!</button>
    </div>
</div>

<div id="particle-container"></div>

<div class="main-game-area">
    <div class="side-panel">
        <div class="header">Market</div>
        <div id="market-list"></div>
        <div class="header" style="margin-top:20px;">Holidays</div>
        <div style="padding:15px;">
            <select id="theme-sel" onchange="updateSeason(this.value)" style="width:100%; font-family:'VT323'; background:#000; color:white; border:4px solid var(--accent); font-size:1.4rem;">
                <option value="default">JUNGLE üå¥</option>
                <option value="newyear">NEW YEAR üéÜ</option>
                <option value="valentine">VALENTINE ‚ù§Ô∏è</option>
                <option value="july4">JULY 4TH üóΩ</option>
                <option value="halloween">HALLOWEEN üéÉ</option>
                <option value="christmas">CHRISTMAS üéÑ</option>
            </select>
            <div id="chat-container">
                <div id="chat-msgs"></div>
                <input type="text" id="chat-in" placeholder="Type message..." maxlength="50">
            </div>
        </div>
    </div>

    <div class="center-stage">
        <div class="name-box">
            <span onclick="changeName()" style="cursor:pointer">PLAYER: <span id="player-name-val">?</span></span>
            <span class="help-btn" onclick="openHelp()">HELP ?</span>
        </div>

        <div class="stats-box">
            <div id="score" class="score-display">0</div>
            <div style="font-size:1.4rem; color:#333; font-weight:bold;">BPS: <span id="bps">0</span> | POW: <span id="pow">1</span> | RB: <span id="rb-count">0</span></div>
        </div>
        
        <div id="rebirth-zone">
            <button class="rebirth-btn" onclick="performRebirth()">REBIRTH! (COST: <span id="rb-cost">1B</span>)</button>
        </div>

        <div id="emoji-clicker" class="pixel-engine">üçå</div>
        
        <div class="leaderboard-container">
            <div class="header" style="font-size:1.2rem; padding:5px;">GLOBAL RANKS</div>
            <div id="lb-content">LOADING...</div>
        </div>
    </div>

    <div class="side-panel">
        <div class="header">Workforce</div>
        <div id="producer-list"></div>
        <div class="header" style="margin-top:10px;">Assets</div>
        <div id="asset-display"></div>
    </div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyCTmXjtfuN-2DGJq9IUpCVvDk88IkFQSFg", authDomain: "banana-empire-42fda.firebaseapp.com", databaseURL: "https://banana-empire-42fda-default-rtdb.firebaseio.com", projectId: "banana-empire-42fda", storageBucket: "banana-empire-42fda.firebasestorage.app", messagingSenderId: "833181965750", appId: "1:833181965750:web:2abf119335bee9a0157517" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const upgrades = {
        market: [
            {id:'m1', name:'Sticky Fingers', base:15, power:1}, {id:'m2', name:'Silverback Grip', base:200, power:5},
            {id:'m3', name:'Golden Peeler', base:1500, power:15}, {id:'m4', name:'Banana Magnet', base:8000, power:50},
            {id:'m5', name:'Quantum Click', base:40000, power:150}, {id:'m6', name:'Grip of Zeus', base:150000, power:500},
            {id:'m7', name:'Nano-Traction', base:750000, power:1200}, {id:'m8', name:'Gravity Glove', base:2500000, power:3500},
            {id:'m9', name:'Hyper-Swiper', base:10000000, power:8000}, {id:'m10', name:'Void Reach', base:50000000, power:20000},
            {id:'m11', name:'Stellar Touch', base:250000000, power:50000}, {id:'m12', name:'Nebula Hook', base:1e9, power:125000},
            {id:'m13', name:'Reality Rip', base:5e9, power:300000}, {id:'m14', name:'Time Squeezer', base:25e9, power:800000},
            {id:'m15', name:'Aether Palm', base:1e11, power:2e6}, {id:'m16', name:'Infinity Pointer', base:5e11, power:5e6},
            {id:'m17', name:'Dimensions Grab', base:25e11, power:12e6}, {id:'m18', name:'Cosmic Grasp', base:1e13, power:35e6},
            {id:'m19', name:'Godly Hand', base:5e13, power:1e8}, {id:'m20', name:'The Absolute', base:25e13, power:5e8}
        ],
        producer: [
            {id:'p1', name:'Rookie Chimp', base:50, bps:2, icon:'üêí'}, {id:'p2', name:'Banana Orchard', base:600, bps:12, icon:'üå≥'},
            {id:'p3', name:'Gorilla Factory', base:4500, bps:55, icon:'üè≠'}, {id:'p4', name:'Industrial Blender', base:25000, bps:220, icon:'ü•§'},
            {id:'p5', name:'Tree Geneticist', base:120000, bps:850, icon:'üß¨'}, {id:'p6', name:'Robo-Harvester', base:650000, bps:3200, icon:'ü§ñ'},
            {id:'p7', name:'Banana Portal', base:3500000, bps:14000, icon:'üåÄ'}, {id:'p8', name:'Lunar Outpost', base:18000000, bps:60000, icon:'üåô'},
            {id:'p9', name:'Solar Farm', base:95000000, bps:250000, icon:'‚òÄÔ∏è'}, {id:'p10', name:'Galactic Hub', base:500000000, bps:1100000, icon:'üõ∏'},
            {id:'p11', name:'Void Miner', base:2500000000, bps:4500000, icon:'üåë'}, {id:'p12', name:'Wormhole Port', base:12000000000, bps:18000000, icon:'üï≥Ô∏è'},
            {id:'p13', name:'Star Forger', base:60000000000, bps:75000000, icon:'‚ú®'}, {id:'p14', name:'Nebula Refiner', base:300000000000, bps:320000000, icon:'üåå'},
            {id:'p15', name:'Time Relic', base:1500000000000, bps:1500000000, icon:'‚è≥'}, {id:'p16', name:'Dimension Mill', base:8e12, bps:7e9, icon:'üèõÔ∏è'},
            {id:'p17', name:'Cosmos Engine', base:4e13, bps:3e10, icon:'‚öôÔ∏è'}, {id:'p18', name:'Reality Core', base:2e14, bps:14e10, icon:'üíé'},
            {id:'p19', name:'Universal Soul', base:1e15, bps:6e11, icon:'üëª'}, {id:'p20', name:'Omega Point', base:5e15, bps:25e11, icon:'üîÜ'}
        ]
    };

    let bananas = parseFloat(localStorage.getItem('bananas')) || 0;
    let counts = JSON.parse(localStorage.getItem('upgradeCounts')) || {};
    let rebirths = parseInt(localStorage.getItem('rebirths')) || 0;
    let playerName = localStorage.getItem('pixelPlayerName') || "Ape_" + Math.floor(Math.random()*999);
    localStorage.setItem('pixelPlayerName', playerName);
    let currentEmoji = 'üçå';

    if(!localStorage.getItem('visited')) {
        document.getElementById('modal-overlay').style.display = 'flex';
        localStorage.setItem('visited', 'true');
    }
    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
    function openHelp() { 
        document.getElementById('modal-title').innerText = "Game Guide";
        document.getElementById('modal-overlay').style.display = 'flex'; 
    }

    function changeName() {
        let n = prompt("Enter your name (max 12 chars):", playerName);
        if (n && n.trim() !== "") {
            playerName = n.substring(0, 12);
            localStorage.setItem('pixelPlayerName', playerName);
            updateUI();
            save();
        }
    }

    function updateSeason(v) {
        document.body.className = 'theme-' + v;
        const themes = { default:'üçå', newyear:'üéÜ', valentine:'‚ù§Ô∏è', july4:'üóΩ', halloween:'üéÉ', christmas:'üéÑ' };
        currentEmoji = themes[v] || 'üçå';
        document.getElementById('emoji-clicker').innerText = currentEmoji;
    }

    function createRain() {
        const p = document.createElement('div');
        p.className = 'falling-item pixel-engine';
        p.innerText = currentEmoji;
        p.style.left = Math.random() * 100 + 'vw';
        p.style.animationDuration = (Math.random() * 3 + 2) + 's';
        document.getElementById('particle-container').appendChild(p);
        setTimeout(() => p.remove(), 5000);
    }

    setInterval(() => {
        const roll = Math.random();
        // Updated Spawn Rates: 15% Golden, 1% Angelic
        if (roll < 0.15) spawnSpecial('golden');
        else if (roll < 0.16) spawnSpecial('angelic'); 
    }, 60000);

    function spawnSpecial(type) {
        const s = document.createElement('div');
        s.className = `special-spawn pixel-engine ${type === 'golden' ? 'golden-b' : 'angelic-b'}`;
        s.innerText = type === 'golden' ? 'üçå' : 'üëº';
        s.style.setProperty('--start-y', Math.random() * 80 + 'vh');
        s.style.setProperty('--end-y', Math.random() * 80 + 'vh');
        s.onclick = () => {
            let b = 0; upgrades.producer.forEach(u => b += (counts[u.id] || 0) * u.bps);
            let bonus = type === 'golden' ? Math.max(500, b * Math.pow(2, rebirths) * 600) : Math.max(5000, b * Math.pow(2, rebirths) * 3600);
            bananas += bonus; updateUI(); s.remove();
        };
        document.body.appendChild(s);
        setTimeout(() => s.remove(), 10000);
    }

    const chatIn = document.getElementById('chat-in');
    const chatMsgs = document.getElementById('chat-msgs');
    chatIn.onkeypress = (e) => {
        if (e.key === 'Enter' && chatIn.value.trim()) {
            db.ref('chat').push({ name: playerName, text: chatIn.value.substring(0, 50), time: Date.now() });
            chatIn.value = '';
        }
    };
    db.ref('chat').limitToLast(20).on('child_added', (snap) => {
        const m = snap.val();
        const d = document.createElement('div');
        d.innerHTML = `<span class="chat-name">${m.name}:</span> ${m.text}`;
        chatMsgs.appendChild(d);
        chatMsgs.scrollTop = chatMsgs.scrollHeight;
    });

    function setupLeaderboard() {
        db.ref('players').orderByChild('score').limitToLast(15).on('value', (snap) => {
            let pl = []; snap.forEach(c => { pl.push(c.val()); });
            pl.sort((a, b) => b.score - a.score);
            document.getElementById('lb-content').innerHTML = pl.map((p, i) => `<div class="lb-entry"><span>#${i+1} ${p.name}</span><span>${Math.floor(p.score).toLocaleString()}</span></div>`).join('');
        });
    }

    function updateUI() {
        let b = 0, p = 1, mult = Math.pow(2, rebirths), rbC = 1e9 * Math.pow(10, rebirths);
        upgrades.producer.forEach(u => b += (counts[u.id] || 0) * u.bps);
        upgrades.market.forEach(u => p += (counts[u.id] || 0) * u.power);
        document.getElementById('score').innerText = Math.floor(bananas).toLocaleString();
        document.getElementById('bps').innerText = Math.floor(b * mult).toLocaleString();
        document.getElementById('pow').innerText = Math.floor(p * mult).toLocaleString();
        document.getElementById('rb-count').innerText = rebirths;
        document.getElementById('player-name-val').innerText = playerName;
        document.getElementById('rb-cost').innerText = (rbC >= 1e12 ? (rbC/1e12).toFixed(1) + 'T' : (rbC/1e9).toFixed(1) + "B");
        document.getElementById('rebirth-zone').style.display = bananas >= rbC * 0.5 ? "block" : "none";

        [...upgrades.market, ...upgrades.producer].forEach(u => {
            let el = document.getElementById('btn-' + u.id);
            if(!el) {
                el = document.createElement('div'); el.id = 'btn-' + u.id; el.className = 'buy-card';
                if(u.id === 'p20') el.classList.add('omega-glow');
                el.onclick = () => buyItem(u.id);
                (upgrades.market.includes(u) ? document.getElementById('market-list') : document.getElementById('producer-list')).appendChild(el);
            }
            const c = Math.floor(u.base * Math.pow(1.15, (counts[u.id] || 0)));
            el.classList.toggle('discovered', bananas >= c * 0.7 || counts[u.id] > 0);
            el.classList.toggle('locked', bananas < c);
            el.innerHTML = `${u.name} <div class="owned-tag">${counts[u.id] || 0}</div><span style="float:right">$${(c >= 1e12 ? (c/1e12).toFixed(1) + 'T' : c.toLocaleString())}</span>`;
        });

        document.getElementById('asset-display').innerHTML = upgrades.producer.filter(u => counts[u.id] > 0).map(u => `<div class="asset-row"><span class="asset-icon pixel-engine">${u.icon}</span><div><b>${u.name} x${counts[u.id]}</b><br>+${(counts[u.id]*u.bps*mult).toLocaleString()} BPS</div></div>`).join('');
    }

    function buyItem(id) {
        const u = [...upgrades.market, ...upgrades.producer].find(x => x.id === id);
        const cost = Math.floor(u.base * Math.pow(1.15, (counts[id] || 0)));
        if(bananas >= cost) { bananas -= cost; counts[id] = (counts[id] || 0) + 1; updateUI(); save(); }
    }

    function performRebirth() {
        let rbC = 1e9 * Math.pow(10, rebirths);
        if(bananas >= rbC) { rebirths++; bananas = 0; counts = {}; save(); updateUI(); }
    }

    function save() {
        localStorage.setItem('bananas', bananas);
        localStorage.setItem('upgradeCounts', JSON.stringify(counts));
        localStorage.setItem('rebirths', rebirths);
        db.ref('players/' + playerName).set({ name: playerName, score: Math.floor(bananas) });
    }

    document.getElementById('emoji-clicker').onclick = () => {
        let p = 1; upgrades.market.forEach(u => p += (counts[u.id] || 0) * u.power);
        bananas += (p * Math.pow(2, rebirths)); updateUI();
    };

    setInterval(() => { 
        let b = 0; upgrades.producer.forEach(u => b += (counts[u.id] || 0) * u.bps); 
        bananas += (b * Math.pow(2, rebirths))/10; updateUI(); 
    }, 100);

    setInterval(createRain, 800);
    setupLeaderboard();
    updateUI();
</script>
</body>
</html>
