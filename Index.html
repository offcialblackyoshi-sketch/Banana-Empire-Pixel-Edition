<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banana Empire: Pixel Edition</title></title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --pixel-border: 6px solid #000;
            --accent: #facc15;
            --main-bg: #064e3b;
            --panel-bg: #78350f;
            --header-bg: #166534;
            --text-box: #fef9c3;
            --danger: #ef4444;
        }

        /* THEMES */
        body.theme-default { --main-bg: #064e3b; --accent: #facc15; --header-bg: #166534; --panel-bg: #78350f; --text-box: #fef9c3; }
        body.theme-newyear { --main-bg: #1e1b4b; --accent: #fcd34d; --header-bg: #312e81; --panel-bg: #1e1b4b; --text-box: #eef2ff; }
        body.theme-valentine { --main-bg: #4c0519; --accent: #fda4af; --header-bg: #9d174d; --panel-bg: #831843; --text-box: #ffe4e6; }
        body.theme-july4 { --main-bg: #0a1128; --accent: #ef4444; --header-bg: #1e3a8a; --panel-bg: #0a1128; --text-box: #f1f5f9; }
        body.theme-halloween { --main-bg: #0c0a09; --accent: #fb923c; --header-bg: #ea580c; --panel-bg: #441907; --text-box: #fed7aa; }
        body.theme-christmas { --main-bg: #052e16; --accent: #ef4444; --header-bg: #991b1b; --panel-bg: #7f1d1d; --text-box: #fee2e2; }

        body, html { height: 100%; margin: 0; font-family: 'VT323', monospace; background-color: var(--main-bg); overflow: hidden; display: flex; flex-direction: column; transition: all 0.5s ease; }
        
        #danger-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; transition: background 0.2s; }
        .danger-flash { background: rgba(239, 68, 68, 0.3); }

        .pixel-engine { 
            image-rendering: pixelated; 
            image-rendering: -moz-crisp-edges; 
            image-rendering: crisp-edges;
            filter: url(#pixelate) contrast(150%) saturate(120%); 
            display: inline-block; 
        }
        
        .main-game-area { display: grid; grid-template-columns: 320px 1fr 320px; flex: 1; padding: 15px; gap: 20px; height: calc(100vh - 65px); z-index: 10; position: relative; }
        .side-panel { border: var(--pixel-border); background: var(--panel-bg); display: flex; flex-direction: column; overflow-y: hidden; box-shadow: 8px 8px 0 #000; }
        .center-stage { display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 10px 0; height: 100%; }
        
        .header { background: var(--header-bg); color: var(--accent); padding: 12px; font-size: 1.8rem; text-align: center; border-bottom: var(--pixel-border); text-transform: uppercase; cursor: pointer; user-select: none; }
        .header:hover { filter: brightness(1.2); }
        
        #market-list, #producer-list { max-height: 380px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--accent) #000; }
        #asset-display { flex-grow: 1; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--accent) #000; background: rgba(0,0,0,0.1); }

        #market-list::-webkit-scrollbar, #producer-list::-webkit-scrollbar, #asset-display::-webkit-scrollbar { width: 8px; }
        #market-list::-webkit-scrollbar-thumb, #producer-list::-webkit-scrollbar-thumb, #asset-display::-webkit-scrollbar-thumb { background: var(--accent); }

        .buy-card { background: var(--header-bg); border: 4px solid #000; color: var(--accent); padding: 10px; margin: 8px; cursor: pointer; display: none; position: relative; box-shadow: 0 4px 0 #000; transition: transform 0.05s; }
        .buy-card.discovered { display: block; }
        .buy-card:active { transform: translateY(2px); box-shadow: 0 2px 0 #000; }
        .buy-card.locked { filter: brightness(0.4); cursor: not-allowed; }
        
        .owned-tag { position: absolute; top: -10px; right: -5px; background: #000; color: #fff; padding: 1px 6px; font-size: 0.9rem; border: 2px solid var(--accent); z-index: 5; }
        
        .name-box { background: #000; border: var(--pixel-border); padding: 5px 15px; margin-bottom: 10px; color: var(--accent); width: 95%; box-sizing: border-box; box-shadow: 6px 6px 0 rgba(0,0,0,0.3); display: flex; justify-content: space-between; align-items: center; }
        .stats-box { background: var(--text-box); border: var(--pixel-border); padding: 12px; width: 95%; text-align: center; box-shadow: 10px 10px 0 #000; }
        .score-display { font-size: 3.5rem; color: #000; line-height: 0.9; }

        #chat-container { margin-top: 15px; border: 4px solid #000; height: 320px; display: flex; flex-direction: column; background: #000; }
        #chat-msgs { flex: 1; overflow-y: auto; color: white; padding: 8px; font-size: 1.2rem; line-height: 1.2; word-wrap: break-word; }
        #chat-in { background: #222; border: none; border-top: 2px solid #444; color: var(--accent); font-family: 'VT323'; padding: 12px; font-size: 1.3rem; outline: none; }
        .chat-name { color: var(--accent); font-weight: bold; }

        .rebirth-btn { background: #ef4444; border: 4px solid #000; color: white; padding: 8px; font-size: 1.4rem; cursor: pointer; box-shadow: 0 4px 0 #000; }

        #emoji-clicker { font-size: 160px; cursor: pointer; user-select: none; transition: transform 0.05s; margin: 5px 0; }
        #emoji-clicker:active, #emoji-clicker.active-key { transform: scale(0.85); }

        .asset-row { display: flex; align-items: center; gap: 10px; padding: 8px; border-bottom: 1px solid rgba(0,0,0,0.4); background: rgba(0,0,0,0.2); color: white; font-size: 0.9rem; }
        .asset-icon { font-size: 2.5rem; width: 45px; text-align: center; line-height: 1; display: inline-block; } 

        .special-spawn { position: absolute; font-size: 50px; cursor: pointer; z-index: 100; animation: floatSpecial 10s linear forwards; user-select: none; }
        .golden-b { filter: drop-shadow(0 0 10px gold) url(#pixelate); }
        .angelic-b { filter: drop-shadow(0 0 15px #00ffff) url(#pixelate); }
        
        .loose-monkey { position: absolute; font-size: 80px; cursor: pointer; z-index: 200; animation: monkeyRun 4s linear forwards; filter: drop-shadow(0 0 10px red); }
        @keyframes monkeyRun {
            from { left: -150px; top: 50%; transform: rotate(0deg); }
            to { left: 110vw; top: 50%; transform: rotate(720deg); }
        }

        @keyframes floatSpecial {
            from { left: -100px; top: var(--start-y); }
            to { left: 110vw; top: var(--end-y); }
        }

        #particle-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
        .falling-item { position: absolute; font-size: 35px; animation: fall linear forwards; pointer-events: auto; }
        @keyframes fall { from { top: -10vh; transform: rotate(0deg); } to { top: 110vh; transform: rotate(360deg); } }
        
        .minimized { display: none !important; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: var(--panel-bg); border: var(--pixel-border); padding: 30px; max-width: 500px; color: #fff; text-align: center; box-shadow: 15px 15px 0 #000; }
        .btn-close { background: var(--accent); color: #000; border: 4px solid #000; padding: 10px 20px; font-family: 'VT323'; font-size: 1.5rem; cursor: pointer; margin-top: 20px; }
    </style>
</head>
<body class="theme-default">

<div id="danger-overlay"></div>

<svg width="0" height="0" style="position:absolute">
    <filter id="pixelate" x="0" y="0">
        <feFlood x="4" y="4" height="2" width="2"/>
        <feComposite width="4" height="4"/>
        <feTile/>
        <feComposite in="SourceGraphic" operator="in"/>
        <feMorphology operator="dilate" radius="1"/>
    </filter>
</svg>

<div id="modal-overlay" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h1 id="modal-title" style="color:var(--accent); text-transform:uppercase;">Welcome to Banana Empire!</h1>
        <div id="modal-body" style="font-size:1.3rem; text-align:left;">
            * <b>CLICK</b> or press <b>SPACE</b> to earn points.<br>
            * <b>DANGER:</b> Catch the "Loose Monkey" üêí before he steals 25% of your hoard!<br>
            * <b>REBIRTH:</b> Reset at 1B for 2x permanent boost.
        </div>
        <button class="btn-close" onclick="closeModal()">GOT IT!</button>
    </div>
</div>

<div id="particle-container"></div>

<div class="main-game-area">
    <div class="side-panel">
        <div class="header" onclick="toggleSection('market-list')">Market (¬±)</div>
        <div id="market-list"></div>
        <div class="header" style="margin-top:20px;">Holidays</div>
        <div style="padding:15px; flex-grow:1; display:flex; flex-direction:column;">
            <select id="theme-sel" onchange="updateSeason(this.value)" style="width:100%; font-family:'VT323'; background:#000; color:white; border:4px solid var(--accent); font-size:1.4rem;">
                <option value="default">JUNGLE üå¥</option>
                <option value="newyear">NEW YEAR üéÜ</option>
                <option value="valentine">VALENTINE ‚ù§Ô∏è</option>
                <option value="july4">JULY 4TH üóΩ</option>
                <option value="halloween">HALLOWEEN üéÉ</option>
                <option value="christmas">CHRISTMAS üéÑ</option>
            </select>
            <div id="chat-container">
                <div id="chat-msgs"></div>
                <input type="text" id="chat-in" placeholder="Type message..." maxlength="50">
            </div>
        </div>
    </div>

    <div class="center-stage">
        <div class="name-box">
            <span onclick="changeName()" style="cursor:pointer">PLAYER: <span id="player-name-val">?</span></span>
            <span class="help-btn" onclick="openHelp()">HELP ?</span>
        </div>

        <div class="stats-box">
            <div id="score" class="score-display">0</div>
            <div style="font-size:1.4rem; color:#333; font-weight:bold;">BPS: <span id="bps">0</span> | POW: <span id="pow">1</span> | RB: <span id="rb-count">0</span></div>
        </div>
        
        <div id="rebirth-zone" style="display:none; margin-top:10px;">
            <button class="rebirth-btn" onclick="performRebirth()">REBIRTH! (COST: <span id="rb-cost">1B</span>)</button>
        </div>

        <div id="emoji-clicker" class="pixel-engine">üçå</div>
        
        <div class="leaderboard-container" style="width: 100%; background: #000; border: var(--pixel-border); color: var(--accent); flex: 1; overflow: hidden; margin-top: 15px; display: flex; flex-direction: column;">
            <div class="header" style="font-size:1.2rem; padding:5px;">GLOBAL RANKS</div>
            <div id="lb-content" style="overflow-y: auto; flex: 1; font-size: 1.4rem; padding: 5px;"></div>
        </div>
    </div>

    <div class="side-panel">
        <div class="header" onclick="toggleSection('producer-list')">Workforce (¬±)</div>
        <div id="producer-list"></div>
        <div class="header" style="margin-top:10px;" onclick="toggleSection('asset-display')">Assets (¬±)</div>
        <div id="asset-display"></div>
    </div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyCTmXjtfuN-2DGJq9IUpCVvDk88IkFQSFg", authDomain: "banana-empire-42fda.firebaseapp.com", databaseURL: "https://banana-empire-42fda-default-rtdb.firebaseio.com", projectId: "banana-empire-42fda", storageBucket: "banana-empire-42fda.firebasestorage.app", messagingSenderId: "833181965750", appId: "1:833181965750:web:2abf119335bee9a0157517" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const marketUpgrades = [];
    const producerUpgrades = [];
    const marketThemes = ["Peel", "Toss", "Grip", "Split", "Mash", "Crunch", "Slip", "Squeeze"];
    const producerThemes = ["Monkey", "Chimp", "Ape", "Gorilla", "Baboon", "Orangutan", "Lemur", "Marmoset"];
    const icons = ['üçå', 'üêí', 'ü¶ç', 'üå¥', 'üéç', 'ü••', 'üçÉ', 'ü•≠'];

    const baseMarket = [{id:'m1', name:'Sticky Fingers', base:25, power:1}, {id:'m2', name:'Silverback Grip', base:500, power:5}];
    marketUpgrades.push(...baseMarket);
    const baseProducers = [{id:'p1', name:'Rookie Chimp', base:100, bps:2, icon:'üêí'}, {id:'p2', name:'Banana Orchard', base:1500, bps:12, icon:'üå≥'}];
    producerUpgrades.push(...baseProducers);

    for(let i=1; i<=515; i++) {
        let prevM = marketUpgrades[marketUpgrades.length-1];
        marketUpgrades.push({ id: 'mx'+i, name: marketThemes[i % 8] + " Rank " + i, base: prevM.base * 1.8, power: prevM.power * 1.25 });
        let prevP = producerUpgrades[producerUpgrades.length-1];
        producerUpgrades.push({ id: 'px'+i, name: producerThemes[i % 8] + " Unit " + i, base: prevP.base * 1.8, bps: prevP.bps * 1.25, icon: icons[i % 8] });
    }

    const upgrades = { market: marketUpgrades, producer: producerUpgrades };

    let bananas = parseFloat(localStorage.getItem('bananas')) || 0;
    let counts = JSON.parse(localStorage.getItem('upgradeCounts')) || {};
    let rebirths = parseInt(localStorage.getItem('rebirths')) || 0;
    let playerName = localStorage.getItem('pixelPlayerName') || "Ape_" + Math.floor(Math.random()*999);
    localStorage.setItem('pixelPlayerName', playerName);
    let currentEmoji = 'üçå';

    function toggleSection(id) { document.getElementById(id).classList.toggle('minimized'); }
    if(!localStorage.getItem('visited')) { document.getElementById('modal-overlay').style.display = 'flex'; localStorage.setItem('visited', 'true'); }
    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
    function openHelp() { document.getElementById('modal-overlay').style.display = 'flex'; }

    async function changeName() {
        let n = prompt("Enter unique name:", playerName);
        if (n && n.trim() !== "" && n !== playerName) {
            n = n.substring(0, 12);
            const snapshot = await db.ref('players/' + n).get();
            if (snapshot.exists()) { alert("Taken!"); return; }
            db.ref('players/' + playerName).remove();
            playerName = n; localStorage.setItem('pixelPlayerName', playerName);
            updateUI(); save();
        }
    }

    function updateSeason(v) {
        document.body.className = 'theme-' + v;
        const themes = { default:'üçå', newyear:'üéÜ', valentine:'‚ù§Ô∏è', july4:'üóΩ', halloween:'üéÉ', christmas:'üéÑ' };
        currentEmoji = themes[v] || 'üçå';
        document.getElementById('emoji-clicker').innerText = currentEmoji;
    }

    function createRain() {
        const p = document.createElement('div');
        p.className = 'falling-item pixel-engine';
        p.innerText = currentEmoji;
        p.style.left = Math.random() * 100 + 'vw';
        p.style.animationDuration = (Math.random() * 3 + 2) + 's';
        document.getElementById('particle-container').appendChild(p);
        setTimeout(() => p.remove(), 5000);
    }

    setInterval(() => {
        const roll = Math.random();
        if (roll < 0.15) spawnSpecial('golden');
        else if (roll < 0.16) spawnSpecial('angelic'); 
    }, 60000);

    setInterval(() => {
        if (Math.random() < 0.01) spawnLooseMonkey();
    }, 30000);

    function spawnLooseMonkey() {
        const m = document.createElement('div');
        m.className = 'loose-monkey pixel-engine';
        m.innerText = 'üêí';
        let caught = false;
        document.getElementById('danger-overlay').classList.add('danger-flash');
        m.onclick = () => {
            caught = true;
            document.getElementById('danger-overlay').classList.remove('danger-flash');
            m.remove();
            alert("Crisis averted! You caught the monkey.");
        };
        document.body.appendChild(m);
        setTimeout(() => {
            if (!caught) {
                let stolen = bananas * 0.25;
                bananas -= stolen;
                document.getElementById('danger-overlay').classList.remove('danger-flash');
                m.remove();
                alert(`OH NO! The monkey escaped with ${formatNum(stolen)} bananas! (25% loss)`);
                updateUI();
            }
        }, 4000);
    }

    function spawnSpecial(type) {
        const s = document.createElement('div');
        s.className = `special-spawn pixel-engine ${type === 'golden' ? 'golden-b' : 'angelic-b'}`;
        s.innerText = type === 'golden' ? 'üçå' : 'üëº';
        s.style.setProperty('--start-y', Math.random() * 80 + 'vh');
        s.style.setProperty('--end-y', Math.random() * 80 + 'vh');
        s.onclick = () => {
            let b = 0; upgrades.producer.forEach(u => b += (counts[u.id] || 0) * u.bps);
            let bonus = type === 'golden' ? Math.max(500, b * Math.pow(2, rebirths) * 600) : Math.max(5000, b * Math.pow(2, rebirths) * 3600);
            bananas += bonus; updateUI(); s.remove();
        };
        document.body.appendChild(s);
        setTimeout(() => s.remove(), 10000);
    }

    const chatIn = document.getElementById('chat-in');
    const chatMsgs = document.getElementById('chat-msgs');
    chatIn.onkeypress = (e) => {
        if (e.key === 'Enter' && chatIn.value.trim()) {
            db.ref('chat').push({ name: playerName, text: chatIn.value.substring(0, 50), time: Date.now() });
            chatIn.value = '';
        }
    };
    db.ref('chat').limitToLast(20).on('child_added', (snap) => {
        const m = snap.val();
        const d = document.createElement('div');
        d.innerHTML = `<span class="chat-name">${m.name}:</span> ${m.text}`;
        chatMsgs.appendChild(d); chatMsgs.scrollTop = chatMsgs.scrollHeight;
    });

    function setupLeaderboard() {
        db.ref('players').orderByChild('score').limitToLast(15).on('value', (snap) => {
            let pl = []; snap.forEach(c => { pl.push(c.val()); });
            pl.sort((a, b) => b.score - a.score);
            document.getElementById('lb-content').innerHTML = pl.map((p, i) => `<div style="display:flex; justify-content:space-between; padding:4px 8px; border-bottom:1px solid #333;"><span>#${i+1} ${p.name}</span><span>${formatNum(p.score)}</span></div>`).join('');
        });
    }

    function formatNum(n) {
        if (n < 1e6) return Math.floor(n).toLocaleString();
        if (n < 1e9) return (n/1e6).toFixed(2) + "M";
        if (n < 1e12) return (n/1e9).toFixed(2) + "B";
        if (n < 1e15) return (n/1e12).toFixed(2) + "T";
        return n.toExponential(2);
    }

    function updateUI() {
        let b = 0, p = 1, mult = Math.pow(2, rebirths), rbC = 1e9 * Math.pow(10, rebirths);
        upgrades.producer.forEach(u => b += (counts[u.id] || 0) * u.bps);
        upgrades.market.forEach(u => p += (counts[u.id] || 0) * u.power);
        document.getElementById('score').innerText = formatNum(bananas);
        document.getElementById('bps').innerText = formatNum(b * mult);
        document.getElementById('pow').innerText = formatNum(p * mult);
        document.getElementById('rb-count').innerText = rebirths;
        document.getElementById('player-name-val').innerText = playerName;
        document.getElementById('rb-cost').innerText = formatNum(rbC);
        document.getElementById('rebirth-zone').style.display = bananas >= rbC * 0.5 ? "block" : "none";

        [...upgrades.market, ...upgrades.producer].forEach(u => {
            let el = document.getElementById('btn-' + u.id);
            if(!el) {
                el = document.createElement('div'); el.id = 'btn-' + u.id; el.className = 'buy-card';
                el.onclick = () => buyItem(u.id);
                (upgrades.market.includes(u) ? document.getElementById('market-list') : document.getElementById('producer-list')).appendChild(el);
            }
            const c = Math.floor(u.base * Math.pow(1.85, (counts[u.id] || 0)));
            el.classList.toggle('discovered', bananas >= c * 0.5 || counts[u.id] > 0);
            el.classList.toggle('locked', bananas < c);
            el.innerHTML = `${u.name} <div class="owned-tag">${counts[u.id] || 0}</div><span style="float:right">$${formatNum(c)}</span>`;
        });
        document.getElementById('asset-display').innerHTML = upgrades.producer.filter(u => counts[u.id] > 0).map(u => `<div class="asset-row"><span class="asset-icon pixel-engine">${u.icon}</span><div><b>${u.name} x${counts[u.id]}</b><br>+${formatNum(counts[u.id]*u.bps*mult)} BPS</div></div>`).join('');
    }

    function buyItem(id) {
        const u = [...upgrades.market, ...upgrades.producer].find(x => x.id === id);
        const cost = Math.floor(u.base * Math.pow(1.85, (counts[id] || 0)));
        if(bananas >= cost) { bananas -= cost; counts[id] = (counts[id] || 0) + 1; updateUI(); save(); }
    }

    function performRebirth() {
        let rbC = 1e9 * Math.pow(10, rebirths);
        if(bananas >= rbC) { rebirths++; bananas = 0; counts = {}; save(); updateUI(); }
    }

    function save() {
        localStorage.setItem('bananas', bananas);
        localStorage.setItem('upgradeCounts', JSON.stringify(counts));
        localStorage.setItem('rebirths', rebirths);
        db.ref('players/' + playerName).set({ name: playerName, score: Math.floor(bananas) });
    }

    function doClick() {
        let p = 1; upgrades.market.forEach(u => p += (counts[u.id] || 0) * u.power);
        bananas += (p * Math.pow(2, rebirths)); updateUI();
    }

    document.getElementById('emoji-clicker').onclick = doClick;

    // ADDED SPACEBAR LISTENER
    window.addEventListener('keydown', (e) => {
        if(e.code === 'Space' && document.activeElement !== chatIn) {
            e.preventDefault(); 
            doClick();
            document.getElementById('emoji-clicker').classList.add('active-key');
        }
    });
    window.addEventListener('keyup', (e) => {
        if(e.code === 'Space') {
            document.getElementById('emoji-clicker').classList.remove('active-key');
        }
    });

    setInterval(() => { 
        let b = 0; upgrades.producer.forEach(u => b += (counts[u.id] || 0) * u.bps); 
        bananas += (b * Math.pow(2, rebirths))/10; updateUI(); 
    }, 100);

    setInterval(save, 5000);
    setInterval(createRain, 800);
    setupLeaderboard();
    updateUI();
</script>
</body>
</html>


